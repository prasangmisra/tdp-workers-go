## Enqueuer

The enqueuer is a simple component with one job; on execution, it performs a select on a table and then dumps the resulting rows onto a message bus.  This enqueuer code is mostly "borrowed" from the tdp-workers-go repo (https://github.com/tucowsinc/tdp-workers-go/tree/develop/pkg/database/model).  It was copied into this repo, with some slight modifications for tdp-notification use.

In the context of tdp-notification, the enqueuer is configured to scan the `v_notifications` view for any new notifications that have appeared; it will then  place each row as a protobuff message onto the bus and then update the source row's status to "publishing".  This is a part of the design for tdp-notification process flow.

The process is kicked off by the `cmd/main.go` code; on invocation, the code will perform the SQL scan/update/messagebus dump as described above before exiting.  It is expected that the `main.go` will be registered with a cron job on the OS to run continually.

The .env file contains system-level configuration (e.g. the database and rabbit mq hostnames and ports)

To run the code, edit the .env file to reflect your environment.  In the database, create a subscription and then create a notification that the subscription is "watching" for. If you execute the `main` code, it will then pick up the notification, update its status to PUBLISHING and then place it on the message bus. 

To change values such as the SQL used to query for v_notifications, and the queue it will output to, look `enqueuerConfig` code in `cmd/main.go`

# Running Tests
To run the tests, run `make itest` 
See the comments in`enqueuer_integration_test.go` for details on how to debug the tests

# The VNotification generated model
The model struct (v_notification.gen.go) used by the enqueuer to read from the database is a file generated by the Gorm "gen tool".

You run the tool and specify a database and table - at which point the tool will connect and to the funky work. 

To install the tool: 

go install gorm.io/gen/tools/gentool@latest

To run it, first make sure the subscription database is up and running, and then run the following command (change the port number if necessary) from the enqueuer/ folder

```
gentool -db postgres -dsn "host=localhost user=tucows password=tucows1234 dbname=subtdpdb port=5434" -outPath internal/database/model -tables 'v_notification' -fieldNullable -fieldWithTypeTag -onlyModel -modelPkgName model
```

You will also need to add the following methods to the generated class:

func (p *VNotification) GetID() string {
	return *p.ID
}

func (p *VNotification) GetNotificationID() string {
	return *p.NotificationID
}

The first method is required to satisfy the interface requirements of the enqueuer;
the second method is just used for the test